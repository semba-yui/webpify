# Implementation Plan

## Task 1: プロジェクト基盤のセットアップ

- [x] 1.1 TypeScript プロジェクトの初期化
  - Node.js 20 LTS 向けの TypeScript 設定（strict モード有効）
  - pnpm によるパッケージ管理の設定
  - ビルドスクリプトの設定（tsc によるコンパイル）
  - _Requirements: なし（技術基盤）_

- [x] 1.2 (P) 依存ライブラリのインストールと設定
  - sharp のインストールと動作確認
  - Commander.js のインストール
  - vitest のインストールとテスト環境設定
  - _Requirements: なし（技術基盤）_

- [x] 1.3 (P) ポートインターフェースの定義
  - ImageProcessorPort の型定義（WebP 変換、メタデータ取得）
  - FileSystemPort の型定義（ファイル操作、ディレクトリ走査）
  - 共通の型定義（ConvertOptions, ConversionResult, ImageInfo 等）
  - _Requirements: なし（技術基盤）_

## Task 2: アダプター層の実装

- [x] 2.1 (P) sharp アダプターの実装
  - ImageProcessorPort を実装した sharp ラッパーの作成
  - WebP 変換機能（品質オプション対応）
  - 画像メタデータ取得機能（幅、高さ、フォーマット）
  - _Requirements: 1.1, 1.3, 3.1, 3.2, 8.4_

- [x] 2.2 (P) ファイルシステムアダプターの実装
  - FileSystemPort を実装した fs ラッパーの作成
  - ファイル存在確認、ディレクトリ判定
  - ディレクトリ作成、ファイルサイズ取得
  - 再帰的ディレクトリ走査
  - _Requirements: 2.3, 4.1, 4.2_

## Task 3: コア層の実装

- [x] 3.1 FileScanner の実装
  - ディレクトリ内の画像ファイル探索機能
  - 拡張子によるフィルタリング（PNG, JPEG, GIF）
  - 再帰オプション対応
  - WebP ファイルのみのフィルタリング（--list 用）
  - _Requirements: 4.1, 4.2, 4.4, 8.2, 8.3_

- [x] 3.2 Converter の基本実装
  - 依存性注入によるポート受け取り
  - 単一ファイルの WebP 変換処理
  - サポート形式の判定（PNG, JPEG, GIF）
  - 出力パスの決定（入力ファイル名 + .webp）
  - 出力ディレクトリの自動作成
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3_

- [x] 3.3 Converter の品質設定と上書き制御
  - 品質パラメータの適用（デフォルト 100）
  - 既存ファイルのスキップ処理
  - force オプションによる上書き許可
  - エラーハンドリング（ファイル不存在、サポート外形式）
  - _Requirements: 1.4, 1.5, 3.1, 3.2, 3.3, 5.1, 5.2, 5.3_

- [x] 3.4 Converter のバッチ処理
  - 複数ファイルの一括変換処理
  - 進捗コールバックの呼び出し
  - 統計情報の集計（成功数、スキップ数、エラー数）
  - _Requirements: 4.1, 4.3, 7.2_

- [x] 3.5 ImageInspector の実装
  - WebP ファイルのメタデータ取得
  - ファイルサイズ、幅、高さの取得
  - バッチ処理対応
  - _Requirements: 8.1, 8.4, 8.6_

## Task 4: CLI 層の実装

- [x] 4.1 ArgumentParser の実装
  - Commander.js による引数定義
  - 入力パス（ファイル/ディレクトリ）の受け取り
  - オプション定義（-o, -q, -r, -f, --quiet, --list）
  - ヘルプメッセージの生成
  - バージョン情報の表示
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 4.2 ArgumentParser のバリデーション
  - 品質値の範囲チェック（1-100）
  - 引数なし時のヘルプ表示
  - エラー時のメッセージ表示と終了コード設定
  - _Requirements: 3.3, 6.3_

- [x] 4.3 Reporter の実装
  - 単一ファイル変換結果の表示（サイズ比較）
  - 進捗表示（ファイル名と処理状況）
  - 統計サマリーの表示（ファイル数、削減量）
  - quiet モード対応
  - _Requirements: 4.3, 7.1, 7.2, 7.3_

- [x] 4.4 Reporter の WebP 一覧表示
  - テーブル形式での一覧出力
  - ファイル名、サイズ（バイト/KB/MB）、幅、高さの表示
  - ファイルが見つからない場合のメッセージ
  - _Requirements: 8.1, 8.2, 8.4, 8.6_

## Task 5: メイン処理の統合

- [x] 5.1 エントリポイントの実装
  - 依存性の組み立て（アダプター生成、コンポーネント生成）
  - 引数パースと実行モード判定
  - 変換モードと一覧モードの分岐
  - _Requirements: 8.5_

- [x] 5.2 単一ファイル変換フローの統合
  - ファイル指定時の変換処理
  - 結果レポートの出力
  - 終了コードの設定
  - _Requirements: 1.1, 1.2, 1.4, 1.5, 7.1_

- [x] 5.3 ディレクトリ変換フローの統合
  - ディレクトリ指定時の一括変換処理
  - 再帰オプションの適用
  - 進捗表示と統計レポート
  - 変換対象なし時の警告
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 7.2_

- [x] 5.4 WebP 一覧表示フローの統合
  - --list オプション時の処理分岐
  - ファイル探索と情報取得
  - 一覧表示の出力
  - _Requirements: 8.1, 8.2, 8.3, 8.5_

## Task 6: テストの実装

- [x] 6.1 (P) ユニットテストの実装
  - Converter のテスト（モック注入による検証）
  - FileScanner のテスト
  - ArgumentParser のテスト
  - Reporter のテスト
  - ImageInspector のテスト
  - _Requirements: 全要件のテストカバレッジ_

- [x] 6.2 (P) 統合テストの実装
  - 実際の sharp/fs を使用した変換テスト
  - テスト用画像ファイル（fixtures）の準備
  - ディレクトリ変換のテスト
  - 上書き制御のテスト
  - _Requirements: 1.1, 4.1, 5.1, 5.2_

- [x] 6.3 E2E テストの実装
  - CLI コマンドの実行テスト
  - ヘルプ・バージョン表示のテスト
  - 変換処理の E2E テスト
  - エラーケースのテスト
  - _Requirements: 6.1, 6.2, 6.3_

## Task 7: 仕上げと最終確認

- [x] 7.1 package.json の設定
  - bin フィールドの設定（CLI コマンド登録）
  - スクリプトの整理（dev, build, test）
  - 依存関係の確認
  - _Requirements: なし（配布準備）_

- [x] 7.2 全機能の動作確認
  - 全オプションの組み合わせテスト
  - エラーハンドリングの確認
  - 終了コードの確認
  - _Requirements: 全要件_
